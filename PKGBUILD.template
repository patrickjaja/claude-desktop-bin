# Maintainer: {{MAINTAINER_NAME}} <{{MAINTAINER_EMAIL}}>
# Contributor: Claude Desktop Linux Community
# AUR Package Repository: https://github.com/patrickjaja/claude-desktop-bin

pkgname=claude-desktop-bin
pkgver={{VERSION}}
pkgrel=1
pkgdesc="Claude AI Desktop Application (Official Binary - Linux Compatible)"
arch=('x86_64')
url="https://claude.ai"
license=('custom:Claude')
depends=('electron' 'nodejs')
makedepends=('p7zip' 'wget' 'asar' 'python')
optdepends=('claude-code: Claude Code CLI for agentic coding features (npm i -g @anthropic-ai/claude-code)')
provides=('claude-desktop')
conflicts=('claude-desktop')
source_x86_64=("Claude-Setup-x64-${pkgver}.exe::{{DOWNLOAD_URL}}")
sha256sums_x86_64=('{{SHA256SUM}}')
options=('!strip')

prepare() {
    cd "$srcdir"

    # Extract the Windows installer
    7z x -y "Claude-Setup-x64-${pkgver}.exe" -o"extract" >/dev/null 2>&1

    # Extract the nupkg
    cd extract
    local nupkg=$(find . -maxdepth 1 -name "AnthropicClaude-*.nupkg" | head -1)
    7z x -y "$nupkg" >/dev/null 2>&1
}

build() {
    cd "$srcdir/extract"

    # Prepare app directory
    mkdir -p "$srcdir/app"
    cp "lib/net45/resources/app.asar" "$srcdir/app/"
    cp -r "lib/net45/resources/app.asar.unpacked" "$srcdir/app/" 2>/dev/null || true

    # Extract and patch app.asar
    cd "$srcdir/app"
    asar extract app.asar app.asar.contents

    # Copy i18n files into app.asar contents before repacking
    echo "Looking for i18n files..."
    mkdir -p app.asar.contents/resources/i18n
    if ls "$srcdir/extract/lib/net45/resources/"*.json 1> /dev/null 2>&1; then
        echo "Found JSON files, copying to app.asar.contents/resources/i18n/"
        cp "$srcdir/extract/lib/net45/resources/"*.json app.asar.contents/resources/i18n/
        # List what we copied for debugging
        ls -la app.asar.contents/resources/i18n/
    else
        echo "Warning: No JSON files found in lib/net45/resources/"
    fi

    # Install Linux-compatible native module (replaces Windows-only @anthropic/claude-native)
    echo "Installing claude-native module..."
    mkdir -p app.asar.contents/node_modules/claude-native
    if [ -f "$startdir/patches/claude-native.js" ]; then
        cp "$startdir/patches/claude-native.js" app.asar.contents/node_modules/claude-native/index.js
        echo "  claude-native module installed"
    else
        echo "Warning: claude-native.js not found"
    fi

    # Apply title bar fix patch
    echo "Applying title bar fix..."
    local mainwindow_js=$(find app.asar.contents -name "MainWindowPage-*.js" 2>/dev/null | head -1)
    if [ -n "$mainwindow_js" ] && [ -f "$startdir/patches/fix_title_bar.py" ]; then
        python3 "$startdir/patches/fix_title_bar.py" "$mainwindow_js" || echo "Warning: Title bar patch failed (non-fatal)"
    else
        echo "Warning: MainWindowPage-*.js or fix_title_bar.py not found"
    fi

    # Apply locale paths fix
    echo "Applying locale paths fix..."
    if [ -f "$startdir/patches/fix_locale_paths.py" ]; then
        python3 "$startdir/patches/fix_locale_paths.py" app.asar.contents/.vite/build/index.js || echo "Warning: Locale paths patch failed (non-fatal)"
    else
        echo "Warning: fix_locale_paths.py not found"
    fi

    # Apply Claude Code Linux support patch
    echo "Applying Claude Code Linux support patch..."
    if [ -f "$startdir/patches/fix_claude_code.py" ]; then
        python3 "$startdir/patches/fix_claude_code.py" app.asar.contents/.vite/build/index.js || echo "Warning: Claude Code patch failed (non-fatal)"
    else
        echo "Warning: fix_claude_code.py not found, skipping Claude Code patch"
    fi

    # Repack app.asar
    asar pack app.asar.contents app.asar
    rm -rf app.asar.contents

    # Copy locales
    mkdir -p "$srcdir/app/locales"
    cp "$srcdir/extract/lib/net45/resources/"*.json "$srcdir/app/locales/" 2>/dev/null || true
}

package() {
    # Install application files
    install -dm755 "$pkgdir/usr/lib/$pkgname"
    cp -r "$srcdir/app"/* "$pkgdir/usr/lib/$pkgname/"

    # Install launcher script
    install -dm755 "$pkgdir/usr/bin"
    cat > "$pkgdir/usr/bin/claude-desktop" << 'EOF'
#!/bin/bash
exec electron /usr/lib/claude-desktop-bin/app.asar "$@"
EOF
    chmod +x "$pkgdir/usr/bin/claude-desktop"

    # Install desktop entry
    install -dm755 "$pkgdir/usr/share/applications"
    cat > "$pkgdir/usr/share/applications/claude-desktop.desktop" << 'EOF'
[Desktop Entry]
Name=Claude
Comment=Claude AI Desktop Application
Exec=claude-desktop %u
Icon=claude-desktop
Type=Application
Terminal=false
Categories=Office;Utility;Chat;
MimeType=x-scheme-handler/claude;
StartupWMClass=Claude
EOF

    # Extract and install icon
    if [ -f "$srcdir/extract/lib/net45/resources/TrayIconTemplate.png" ]; then
        install -Dm644 "$srcdir/extract/lib/net45/resources/TrayIconTemplate.png" \
            "$pkgdir/usr/share/icons/hicolor/256x256/apps/claude-desktop.png"
    fi
}

# vim: set ts=4 sw=4 et: