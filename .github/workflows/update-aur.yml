name: Update AUR Package

on:
  schedule:
    - cron: '0 2 * * *'  # Run daily at 2 AM UTC
  workflow_dispatch:  # Allow manual trigger
    inputs:
      download_url:
        description: 'Manual download URL (optional - bypasses auto-detection if Cloudflare blocks)'
        required: false
        type: string
  push:
    branches:
      - master
    paths:
      - '.github/workflows/update-aur.yml'
      - 'scripts/**'
      - 'PKGBUILD.template'

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Need write permission to create releases
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full wget

      - name: Download Claude Setup and capture URL
        id: download
        run: |
          # Check if manual download URL was provided via workflow_dispatch input
          if [ -n "${{ github.event.inputs.download_url }}" ]; then
            echo "Using manually provided download URL"
            DOWNLOAD_URL="${{ github.event.inputs.download_url }}"
            echo "Download URL: ${DOWNLOAD_URL}"

            # Download using the provided URL
            wget -q -O Claude-Setup-x64.exe \
              -U "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
              "${DOWNLOAD_URL}"
          else
            echo "Auto-detecting download URL from redirect"
            # Download the file and capture headers in verbose mode
            # wget follows redirects by default and logs the final URL
            wget --server-response -O Claude-Setup-x64.exe \
              -U "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
              "https://claude.ai/api/desktop/win32/x64/exe/latest/redirect" \
              2>&1 | tee wget_output.txt

            # Extract the Location header from the redirect response
            DOWNLOAD_URL=$(grep -i '^ *Location:' wget_output.txt | tail -1 | sed -E 's/^[[:space:]]*[Ll]ocation:[[:space:]]*//' | sed 's/ \[following\]$//' | tr -d '\r\n')

            if [ -z "$DOWNLOAD_URL" ]; then
              echo "Error: Failed to extract download URL from redirect"
              echo "wget output:"
              cat wget_output.txt
              exit 1
            fi

            echo "Resolved download URL: ${DOWNLOAD_URL}"
            rm -f wget_output.txt
          fi

          # Save URL to output for PKGBUILD generation
          echo "url=${DOWNLOAD_URL}" >> $GITHUB_OUTPUT

          # Calculate SHA256 of the downloaded file
          SHA256=$(sha256sum Claude-Setup-x64.exe | cut -d' ' -f1)
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT

      - name: Extract version
        id: version
        run: |
          VERSION=$(bash ./scripts/extract-version.sh Claude-Setup-x64.exe)
          echo "Version extracted: ${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Check if version changed
        id: check
        run: |
          # Get the latest tag from GitHub releases
          LATEST_TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | grep '"tag_name":' | sed -E 's/.*"v?([^"]+)".*/\1/' || echo "0.0.0")
          echo "Latest GitHub release: ${LATEST_TAG}"
          echo "Current version: ${{ steps.version.outputs.version }}"

          if [ "$LATEST_TAG" != "${{ steps.version.outputs.version }}" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Version changed from ${LATEST_TAG} to ${{ steps.version.outputs.version }}"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Version unchanged"
          fi

      - name: Generate PKGBUILD
        if: steps.check.outputs.needs_update == 'true' || github.event_name == 'workflow_dispatch'
        env:
          AUR_USERNAME: ${{ secrets.AUR_USERNAME }}
          AUR_EMAIL: ${{ secrets.AUR_EMAIL }}
        run: |
          bash ./scripts/generate-pkgbuild.sh "${{ steps.version.outputs.version }}" "${{ steps.download.outputs.sha256 }}" "${{ steps.download.outputs.url }}" > PKGBUILD

      - name: Test Build in Arch Container
        if: steps.check.outputs.needs_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "=== Testing PKGBUILD in Arch Linux container ==="
          echo "This validates all patches apply correctly before pushing to AUR"

          # Prepare build directory
          mkdir -p /tmp/test-build
          cp PKGBUILD /tmp/test-build/
          cp "Claude-Setup-x64.exe" "/tmp/test-build/Claude-Setup-x64-${{ steps.version.outputs.version }}.exe"

          # Modify PKGBUILD to use local file instead of downloading
          sed -i "s|source_x86_64=.*|source_x86_64=(\"Claude-Setup-x64-\${pkgver}.exe\")|" /tmp/test-build/PKGBUILD
          sed -i "s|sha256sums_x86_64=.*|sha256sums_x86_64=('SKIP')|" /tmp/test-build/PKGBUILD

          # Run build in Arch container
          # Use pipefail to catch errors in piped commands
          docker run --rm \
            -v /tmp/test-build:/build \
            -w /build \
            archlinux:base-devel \
            bash -c "
              set -eo pipefail
              echo '=== Installing build dependencies ==='
              pacman -Syu --noconfirm
              pacman -S --noconfirm p7zip wget python nodejs npm fakeroot binutils electron git base-devel

              echo '=== Creating builder user ==='
              useradd -m builder
              echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
              chown -R builder:builder /build

              echo '=== Installing yay (AUR helper) ==='
              cd /tmp
              git clone https://aur.archlinux.org/yay-bin.git
              chown -R builder:builder yay-bin
              cd yay-bin
              su builder -c 'makepkg -si --noconfirm'

              echo '=== Installing asar from AUR ==='
              su builder -c 'yay -S --noconfirm asar'

              echo '=== Running makepkg (test build) ==='
              cd /build
              su builder -c 'makepkg -sf --noconfirm' 2>&1 | tee /build/build.log
              MAKEPKG_EXIT=\${PIPESTATUS[0]}
              if [ \$MAKEPKG_EXIT -ne 0 ]; then
                echo 'ERROR: makepkg failed with exit code' \$MAKEPKG_EXIT
                exit \$MAKEPKG_EXIT
              fi

              echo '=== Test build completed successfully ==='
              echo 'All patches applied correctly!'
            " 2>&1 | tee build-output.log

          BUILD_EXIT=${PIPESTATUS[0]}

          if [ $BUILD_EXIT -ne 0 ]; then
            echo ""
            echo "::error::Test build FAILED!"
            echo ""
            echo "=== PATCH FAILURE DETAILS ==="
            grep -E "(ERROR|FAIL|\[FAIL\])" build-output.log || true
            echo ""
            echo "The upstream Claude Desktop may have changed."
            echo "Please update the patch patterns to match the new file structure."
            exit 1
          fi

          echo "Test build passed - safe to push to AUR"

      - name: Upload Build Log
        if: always() && (steps.check.outputs.needs_update == 'true' || github.event_name == 'workflow_dispatch')
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ steps.version.outputs.version }}
          path: build-output.log
          retention-days: 30
          if-no-files-found: ignore

      - name: Generate .SRCINFO
        if: steps.check.outputs.needs_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          # Install makepkg dependencies
          sudo apt-get install -y libarchive-tools binutils fakeroot

          # Generate .SRCINFO without building
          cat << 'EOF' > generate-srcinfo.sh
          #!/bin/bash
          source PKGBUILD

          echo "pkgbase = ${pkgname}"
          echo -e "\tpkgdesc = ${pkgdesc}"
          echo -e "\tpkgver = ${pkgver}"
          echo -e "\tpkgrel = ${pkgrel}"
          echo -e "\turl = ${url}"
          echo -e "\tarch = ${arch[0]}"
          echo -e "\tlicense = ${license[0]}"

          for dep in "${makedepends[@]}"; do
            echo -e "\tmakedepends = ${dep}"
          done

          for dep in "${depends[@]}"; do
            echo -e "\tdepends = ${dep}"
          done

          i=0
          for src in "${source[@]}"; do
            if [[ $src == *"::"* ]]; then
              echo -e "\tsource = ${src}"
            else
              echo -e "\tsource = ${src}"
            fi
          done

          for sum in "${sha256sums[@]}"; do
            echo -e "\tsha256sums = ${sum}"
          done

          echo ""
          echo "pkgname = ${pkgname}"
          EOF

          bash generate-srcinfo.sh > .SRCINFO
          rm generate-srcinfo.sh

      - name: Setup SSH for AUR
        if: steps.check.outputs.needs_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          ssh-keyscan -t rsa aur.archlinux.org >> ~/.ssh/known_hosts

          # Configure SSH to use the key
          cat << EOF >> ~/.ssh/config
          Host aur.archlinux.org
            User aur
            IdentityFile ~/.ssh/aur
            StrictHostKeyChecking no
          EOF

      - name: Push to AUR
        if: steps.check.outputs.needs_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          # Configure git
          git config --global user.name "${{ secrets.AUR_USERNAME }}"
          git config --global user.email "${{ secrets.AUR_EMAIL }}"

          # Clone AUR repository
          git clone ssh://aur@aur.archlinux.org/claude-desktop-bin.git aur-repo

          # Copy updated files
          cp PKGBUILD .SRCINFO aur-repo/

          # Commit and push
          cd aur-repo
          git add PKGBUILD .SRCINFO
          git diff --staged --quiet || {
            git commit -m "Update to version ${{ steps.version.outputs.version }}"
            git push origin master
            echo "Successfully pushed to AUR"
          }

      - name: Create GitHub Release
        if: steps.check.outputs.needs_update == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Claude Desktop ${{ steps.version.outputs.version }}
          body: |
            ## Claude Desktop ${{ steps.version.outputs.version }}

            This release updates the AUR package to Claude Desktop version ${{ steps.version.outputs.version }}.

            ### Installation
            ```bash
            yay -S claude-desktop-bin
            ```

            ### Changes
            - Updated to Claude Desktop ${{ steps.version.outputs.version }}
            - SHA256: ${{ steps.download.outputs.sha256 }}

            ### AUR Package
            https://aur.archlinux.org/packages/claude-desktop-bin
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          rm -f Claude-Setup-x64.exe
          rm -rf ~/.ssh/aur